# Техническое исследование и оценка проекта `job-monitor-bot`

## Краткая оценка

- **Идея и MVP-ценность:** высокая — понятный pipeline `парсинг → фильтрация → дедупликация → доставка в Telegram`.
- **Кодовая зрелость:** средняя/ниже средней — архитектура частично дублируется между `src/` и `api/`.
- **Надёжность прод-эксплуатации:** средняя — есть базовая обработка ошибок, но мало наблюдаемости и тестов.
- **Безопасность:** низкая — в репозитории присутствует хардкод токена бота.

**Итоговая оценка: 6/10.**

## Что сделано хорошо

1. **Рабочий асинхронный стек** (`aiohttp`, `asyncpg`, `aiogram`) и понятная предметная логика.
2. **Есть дедупликация** на уровне hash + fuzzy matching, что полезно для агрегатора.
3. **Есть интерфейс админа в Telegram**: digest/stats/export/channels/keywords.
4. **Подготовлен Vercel deploy**: маршруты + cron-конфигурация.

## Ключевые проблемы

### 1) Критический риск безопасности
- В `setup_webhook.py` токен бота зашит в коде.
- Это прямой риск компрометации бота, перехвата webhook, отправки спама/удаления webhook.

### 2) Дублирование и рассинхрон логики
- Есть две разные реализации команд и поведения:
  - `src/bot.py` (полноценный интерфейс с DB)
  - `api/webhook.py` (упрощённый интерфейс и удалённый вызов `/api/cron`)
- Аналогично, парсинг/фильтрация живут и в `src/parser.py`, и в `api/cron.py` (разные наборы каналов и правил).
- Это делает поведение бота непредсказуемым и усложняет сопровождение.

### 3) Несогласованность документации
- README предлагает `python src/main.py`, но файла `src/main.py` в репозитории нет.
- Это ухудшает first-run опыт и повышает вероятность ошибок запуска.

### 4) Проблемы качества данных при парсинге HTML
- В обоих парсерах посты и тексты собираются отдельными regex-списками и затем сопоставляются индексом.
- Если структура HTML меняется или появляется вложенность/служебные блоки, возможна неверная привязка текста к post_id.

### 5) Ограниченная наблюдаемость
- Логирование в основном через `print`, отсутствуют уровни логов, request id, метрики, алерты.
- Трудно расследовать деградацию (пустые дайджесты, сетевые таймауты, падения парсинга).

### 6) Отсутствие тестового покрытия
- Нет unit/integration тестов для фильтрации, дедупликации и критических API-путей.
- Изменения в словарях ключевых слов/стоп-слов могут незаметно сломать precision/recall.

## Оценка по блокам

| Блок | Оценка | Комментарий |
|---|---:|---|
| Архитектура | 5/10 | MVP работает, но дублирование `src`/`api` повышает технический долг |
| Безопасность | 2/10 | Хардкод токена — критический issue |
| Надёжность | 6/10 | Есть retries/исключения частично, но нет строгой идемпотентности пайплайна |
| Производительность | 7/10 | Батчинг каналов и async-подход адекватны для MVP |
| DX/поддерживаемость | 5/10 | Нет тестов, README частично устарел |

## Рекомендуемый план улучшений

### P0 (срочно, в первую очередь)
1. Удалить токен из git-истории и **обязательно перевыпустить** BOT_TOKEN в BotFather.
2. Перенести `setup_webhook.py` на переменную окружения `BOT_TOKEN`.
3. Выбрать **один источник правды** для логики команд и парсинга (либо `src/*`, либо `api/*`) и убрать дубли.

### P1 (в ближайший спринт)
1. Исправить README и добавить точный runbook (локально и на Vercel).
2. Добавить базовые тесты:
   - `is_job_posting` / `is_help_request`
   - hash/similarity дедупликация
   - smoke-test webhook handler.
3. Улучшить HTML-парсер: перейти на более устойчивый парсинг (например, CSS/XPath через `BeautifulSoup`/`lxml`) вместо индексного сопоставления списков regex.

### P2 (после стабилизации)
1. Добавить structured logging (json-формат) и простые метрики.
2. Добавить rate-limits/таймауты/повторы с backoff.
3. Вынести словари каналов и ключевых слов в конфигурацию/БД для управляемости без релиза.

## Вывод

Проект имеет хороший практический потенциал и уже решает полезную задачу, но в текущем виде ограничен рисками безопасности и архитектурной раздвоенностью. После устранения P0/P1 пунктов можно ожидать заметный рост стабильности и качества результата, а также проще масштабировать поддержку новых источников и правил фильтрации.
